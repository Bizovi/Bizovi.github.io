<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.37.1" />
  <meta name="author" content="Bizovi Mihai">
  <meta name="description" content="Data Scientist @Adore Me">

  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.0/css/academicons.min.css" integrity="sha512-GGGNUPDhnG8LEAEDsjqYIQns+Gu8RBs4j5XGlxl7UfRaZBhCCm5jenJkeJL8uPuOXGqgl8/H1gjlWQDRjd3cUQ==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather%7CRoboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-104200881-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Data Analysis &amp; Economic Cybernetics">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Data Analysis &amp; Economic Cybernetics">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="/post/2017-11-18-r-tutorial-behavioral-economics-2/">

  

  <title>R Tutorials for Behavioral Economics Class | Data Analysis &amp; Economic Cybernetics</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Data Analysis &amp; Economic Cybernetics</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/post">
            
            <span>Blog</span>
          </a>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <h1 itemprop="name">R Tutorials for Behavioral Economics Class</h1>
    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2017-11-22 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Wed, Nov 22, 2017
    </time>
  </span>

  

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="/tags/r">R</a
    >, 
    
    <a href="/tags/behavioral-economics">behavioral-economics</a
    >, 
    
    <a href="/tags/data-visualization">data-visualization</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fpost%2f2017-11-18-r-tutorial-behavioral-economics-2%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=R%20Tutorials%20for%20Behavioral%20Economics%20Class&amp;url=%2fpost%2f2017-11-18-r-tutorial-behavioral-economics-2%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fpost%2f2017-11-18-r-tutorial-behavioral-economics-2%2f&amp;title=R%20Tutorials%20for%20Behavioral%20Economics%20Class"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fpost%2f2017-11-18-r-tutorial-behavioral-economics-2%2f&amp;title=R%20Tutorials%20for%20Behavioral%20Economics%20Class"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=R%20Tutorials%20for%20Behavioral%20Economics%20Class&amp;body=%2fpost%2f2017-11-18-r-tutorial-behavioral-economics-2%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

    <div class="article-style" itemprop="articleBody">
      <p>In the last blog post I took a bird’s eye (personal) perspective of R programming and suggested not to be discouraged by early encounters with this seemingly weird language. The conclusion was that by following “the right tool for the right job” principle, R is a great language for statistical research and the ecosystem of packages improves the data analysis workflow and gives the modeler more tools to extract insights from data.</p>
<blockquote>
<p>What is the link to Behavioral Economics? R will be used (in class) as a tool for exploring domain-specific data in order to make informed decisions, fitting different kinds of models and validating the intuition from readings like Tversky &amp; Kahneman, Thaler on real data.</p>
</blockquote>
<div id="a-tutorial-on-metropolitan-area-housing" class="section level2">
<h2>A tutorial on Metropolitan Area Housing</h2>
<pre class="r"><code>library(tidyverse) # the ecosystem of data processing tools
library(tidyr)     # useful for getting the data in short-long formats
library(reshape2)  # for the function melt (long format data)
library(glue)      # string formatting
library(assertive) # assertions (active tests)
library(ochRe)     # stunning color palettes
library(readxl)    # read from excel spreadsheets</code></pre>
<pre class="r"><code>data &lt;- read_excel(&quot;data/landdata-msas-2016q1.xls&quot;, skip = 1)
data &lt;- data %&gt;% 
  mutate(MSA = as.factor(MSA), 
         Date = zoo::as.yearqtr(Date, format = &quot;%YQ%q&quot;)
         ) %&gt;%
  dplyr::rename(home_value = `Home Value`, 
                structure_cost = `Structure Cost`, 
                land_value = `Land Value`, 
                land_share = `Land Share (Pct)`, 
                home_pi = `Home Price Index`, 
                land_pi = `Land Price Index`
                )
data %&gt;% head()</code></pre>
<pre><code>## # A tibble: 6 x 8
##   MSA    Date      home_value structure_cost land_value land_share home_pi
##   &lt;fct&gt;  &lt;S3: yea&gt;      &lt;dbl&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;
## 1 ATLAN~ 1984 Q4       92856.         67112.     25744.      0.277   0.538
## 2 ATLAN~ 1985 Q1       93044.         67826.     25218.      0.271   0.540
## 3 ATLAN~ 1985 Q2       93269.         68444.     24825.      0.266   0.541
## 4 ATLAN~ 1985 Q3       97490.         69027.     28464.      0.292   0.565
## 5 ATLAN~ 1985 Q4       98809.         69562.     29247.      0.296   0.573
## 6 ATLAN~ 1986 Q1       99847.         70078.     29768.      0.298   0.579
## # ... with 1 more variable: land_pi &lt;dbl&gt;</code></pre>
<pre class="r"><code>ny &lt;- data %&gt;% dplyr::filter(MSA == &quot;NEWYORK&quot;) 
ny %&gt;% 
  tidyr::gather(key = variable, value = value, -c(MSA, Date)) %&gt;% 
  dplyr::select(-MSA) %&gt;% 
  ggplot(aes(x = value, fill = variable)) + 
  geom_histogram(alpha = 0.5) + 
  facet_wrap(~ variable, scale = &quot;free&quot;) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(y = &quot;Frequency&quot;, title = &quot;Distributions of the variables for NY&quot;) + 
  theme(legend.position = &quot;none&quot;) + 
  scale_fill_ochre(palette = &quot;nolan_ned&quot;)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="/post/2017-11-18-r-tutorial-behavioral-economics-2_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="plotting-theoretical-utility-and-value-functions" class="section level2">
<h2>Plotting theoretical Utility and Value functions</h2>
<p>Hyperbolic Absolute Risk Aversion (Linear Risk Tolerance) is a class of utility functions, that can easily describe the particular cases of Constant Absolute Risk Aversion (CARA) and Constant Relative Risk Aversion (CRRA). <span class="math display">\[U(x;\gamma,a,b) = \frac{1 - \gamma}{\gamma}\bigg( \frac{ax}{1-\gamma} +b   \bigg) ^ \gamma\]</span> It is designed in such a way that the risk tolerance is linear <span class="math display">\[\tau(x)=-\frac{U&#39;(x)}{U&#39;&#39;(x)} = \frac{1}{1-\gamma}x + 
\frac{b}{a}
\]</span> where <span class="math inline">\(a &gt; 0\)</span> and <span class="math inline">\(\frac{ax}{1-\gamma} + b &gt; 0\)</span></p>
<p>The function tends to logarithmic if gamma tends to zero (by L’Hopital rule) and linear when goes to one. <span class="math display">\[U(x) \xrightarrow[\gamma \to 0]{} log(ax+b)\]</span></p>
<blockquote>
<p>The reason we’re going to overkill a simple plotting of HARA utility function is to showcase some important R concepts.</p>
</blockquote>
<p>First, we test user inputs via the <code>assertthat</code> package, which is a first step moving from manual validation to more automated methods of code testing. This doesn’t kick in when doing an exploratory analysis, but hopefully when starting to build Packages, learning how to test code in R<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> will pay off.</p>
<pre class="r"><code>hara &lt;- function(x, a, b, gamma) {
  # check that inputs to the function are good
  # using assetthat package
  assert_all_are_non_negative(x)
  assert_all_are_greater_than(x = a * x / (1 - gamma) + b, y = 0)
  assert_all_are_true(
    c(    
      is_positive(a), 
      is_not_equal_to(a, 0), 
      is_in_range(gamma, lower = 0, upper = 1)
      )
  )
  
  # return the function itself
  return(
    ((1 - gamma) / gamma) * (a * x / (1 - gamma) + b)^gamma
  )
}</code></pre>
<p>Second, we want to run the function a number of times by varying a parameter. The first idea of would be to write a for loop, but there is a more elegant way. The apply family of functions allows to run a function on elements of objects like lists. In this particular case I used a <code>sapply</code> function which returns a data frame with a column for values of function given a parameter.</p>
<pre class="r"><code># check if the function returns expected values
# hara(x = 1:20, a = 36, b = 52, gamma = 0.5)

gammas &lt;- c(0.5, 0.4, 0.3, 0.25, 0.1)
a &lt;- 36 # the functions start to look more linear as a is small
b &lt;- 52 

# apply the function on using 4 different gamma parameters
df &lt;- sapply(X = gammas, FUN = hara, x = 0:30,  a = a, b = b) %&gt;% 
  as_tibble()
# add the appropriate values to column names
colnames(df) &lt;- as.character(gammas)</code></pre>
<p>Third, we use the tidy way of data processing by heavily relying on the pipe operator <code>%&gt;%</code>, which passes an output of a function or an object to the next one. This makes the code much more readable and shows its power in Exploratory Data Analysis. The concept of Tidy Data<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> is inspired from relational databases and in order to use R eficiently one needs to understand the use-cases for long and wide data formats, what classifies as tidy.</p>
<p>The fourth point is that using <code>ggplot2</code> as the go-to visualization tool is not harder or more advanced, but simpler! Once you understand the <code>grammar of graphics</code><a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> you get an incredibly general tool for data visualization, in which you can do stunning graphs with very little effort once you get the data into the right format.</p>
<pre class="r"><code>df %&gt;% 
  mutate(x = 1:nrow(df)) %&gt;% 
  reshape2::melt(id.vars = &quot;x&quot;) %&gt;% # could use tidyr::gather as an alternative
  rename(gamma = variable) %&gt;%
  ggplot(aes(x = x, y = value, color = gamma)) + 
  geom_line(size = 1) + 
  theme_minimal() + 
  labs(title = &quot;Hyperbolic Absolute Risk Aversion function&quot;, 
       subtitle = glue(&quot;with hyperparameters a = {a}, b = {b}&quot;)) + 
  scale_color_ochre(palette = &quot;nolan_ned&quot;) # if you feel fancy today</code></pre>
<p><img src="/post/2017-11-18-r-tutorial-behavioral-economics-2_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<pre class="r"><code>## Explain what is a color palette and why is it useful</code></pre>
</div>
<div id="a-tutorial-on-analysis-of-returns-and-investment-decisions" class="section level2">
<h2>A tutorial on Analysis of Returns and Investment Decisions</h2>
<!--

```r
library(tidyquant) # tidy data analysis and financial data interfacing
```


```r
# get stock prices for seven years using the Yahoo Finance API
stocks <- c("ORCL", "FSLR", "AMZN", "GOOG", "GE") %>% tq_get(
  get  = "stock.prices", 
  from = "2010-01-01", 
  to   = "2017-10-30"
)

# calculate the monthly returns
monthly.returns <- stocks %>% 
  group_by(symbol) %>% 
  tq_transmute(
    select     = adjusted, # column to calculate returns from 
    mutate_fun = periodReturn, # function from quantmod
    period     = "monthly",    # alternatively, "weekly" or daily
    col_rename = "return")

# need to compare against a general price index
baseline <- "SPX" %>%
    tq_get(
      get  = "stock.prices",
      from = "2010-01-01",
      to   = "2017-10-30") 


monthly.baseline <- baseline %>%
    tq_transmute(
      select     = adjusted, 
      mutate_fun = periodReturn, 
      period     = "monthly", 
      col_rename = "base.returns")
```

```
## Warning in to_period(xx, period = on.opts[[period]], ...): missing values
## removed from data
```


```r
# In order to perserve some information when averaging at monthly level, it would be great to represent the uncecrtainty

custom_stat_fun <- function(x, na.rm = TRUE, ...) {
    # ...   = additional arguments
    c(mean    = mean(x, na.rm = na.rm),
      stdev   = sd(x, na.rm = na.rm),
      quantile(x, na.rm = na.rm, ...)) 
}

# quantiles
pr <- c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1)

# Applying the custom function by week
monthly_returns <- stocks %>%
  group_by(symbol) %>%
    tq_transmute(
        select = close,
        mutate_fun = apply.monthly, 
        FUN = custom_stat_fun,
        na.rm = TRUE,
        probs = pr
    )

monthly_returns %>%
    ggplot(aes(x = date, y = `50%`, color = symbol)) +
    geom_ribbon(aes(ymin = `25%`, ymax = `75%`), 
                color = NA, fill = palette_light()[[1]], alpha = 0.3) +
    geom_point() +
    geom_vline(xintercept = as.Date(c("2011-09-01", "2012-07-01", 
                                      "2013-07-01", "2014-02-01", 
                                      "2015-01-01", "2016-02-01")), 
               lty = 2, color = "grey40") + 
    geom_ma(n = 5, size = 1, color = "steelblue2", lty = 1) + 
    facet_wrap(~ symbol, ncol = 2, scale = "free_y") +
    labs(title = "Standard and Poor's Average Monthly Price", x = "",
         subtitle = "Volatility shown as 1st and 3rd quantiles",
         y = "Price (k$)") +
  #  expand_limits(y = 50) + 
    scale_color_ochre(palette = "lorikeet") +
    theme_bw() + 
  theme(legend.position = "none")
```

<img src="/post/2017-11-18-r-tutorial-behavioral-economics-2_files/figure-html/unnamed-chunk-9-1.png" width="672" />

-->
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Testing R Code <a href="http://r-pkgs.had.co.nz/tests.html" class="uri">http://r-pkgs.had.co.nz/tests.html</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Hadley Wickham’s R for Data Science <a href="http://r4ds.had.co.nz/" class="uri">http://r4ds.had.co.nz/</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Paper on the grammar of Graphics <a href="http://byrneslab.net/classes/biol607/readings/wickham_layered-grammar.pdf" class="uri">http://byrneslab.net/classes/biol607/readings/wickham_layered-grammar.pdf</a><a href="#fnref3">↩</a></p></li>
</ol>
</div>

    </div>
  </div>

</article>

<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="/post/2017-11-01-r-tutorial-behavioral-economics/"><span
      aria-hidden="true">&larr;</span> R Programming. The big picture</a></li>
    

    
    <li class="next"><a href="/post/2017-11-25-reproducing-the-economist-chart/">Reproducing The Economist Chart <span
      aria-hidden="true">&rarr;</span></a></li>
    
  </ul>
</nav>

</div>

<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Bizovi" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Bizovi Mihai &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha512-jGsMH83oKe9asCpkOVkBnUrDDTp8wl+adkB2D+//JtlxO4SrLoJdhbOysIFQJloQFD+C4Fl1rMsQZF76JjV0eQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js" integrity="sha512-iHzEu7GbSc705hE2skyH6/AlTpOfBmkx7nUqTLGzPYR+C1tRaItbRlJ7hT/D3YQ9SV0fqLKzp4XY9wKulTBGTw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js" integrity="sha512-Z5heTz36xTemt1TbtbfXtTq5lMfYnOkXM2/eWcTTiLU01+Sw4ku1i7vScDc8fWhrP2abz9GQzgKH5NGBLoYlAw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/plugins/ScrollToPlugin.min.js" integrity="sha512-CDeU7pRtkPX6XJtF/gcFWlEwyaX7mcAp5sO3VIu/ylsdR74wEw4wmBpD5yYTrmMAiAboi9thyBUr1vXRPA7t0Q==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/r.min.js"></script>
      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

